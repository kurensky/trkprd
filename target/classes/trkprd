#!/bin/sh
#
# trkprd        Startup script for the TRKPRD for Universal Driver
#
# chkconfig: - 88 10
# description: Startup script for the TRKPRD for Universal Driver. \
#	       XML type driver.
# processname: ru.novoscan.TCPtrkprd
# config: /opt/novoscan/trkprd/trkprd.conf
# pidfile: /var/run/trkprd.pid

# Source function library.
. /etc/rc.d/init.d/functions

#set -e

PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
DESC="TRKPRD for Sync Scout Daemon"
NAME="trkprd"
USER="novoscan"
HOME="/opt/novoscan/$NAME"
CP="$HOME:/opt/novoscan/lib/postgresql.jar:/opt/novoscan/lib/log4j.jar"
MAIN="ru.novoscan.trkpd.TCPtrkprd"
ARGS="-f /opt/novoscan/trkprd/trkprd.conf"
RETVAL=0

DAEMON="/usr/bin/java -server -cp $CP -Djava.awt.headless=true -Dlog4j.configuration=file://$HOME/log4j.properties $MAIN $ARGS"
PIDFILE=/var/run/$NAME.pid
SCRIPTNAME=/etc/init.d/$NAME

# Gracefully exit if the package has been removed.
test -x /usr/bin/java || exit 0

# ---------------------------------------
# Function that starts the daemon/service
# ---------------------------------------
start()
{
	echo -n "Starting $DESC $NAME: "
	PID=`pgrep -f "$DAEMON"`
	if [ -n "$PID" ]; then
		echo_warning
		echo $PID > $PIDFILE
               	RETVAL=0
	else
		su -p -s /bin/sh $USER -c "$DAEMON &>/dev/null &"
		PID=`pgrep -f "$DAEMON"`
		if [ -n "$PID" ]; then
			echo_success
	               	RETVAL=0
		else
			echo_failure
	               	RETVAL=1
		fi
	fi
	echo
	return $RETVAL
}
 
# --------------------------------------
# Function that stops the daemon/service
# --------------------------------------
stop()
{
  	echo -n "Stopping $DESC $NAME: "
	PID=`pgrep -f "$DAEMON"`
        if [ $UID -ne 0 ]; then
                RETVAL=1
		echo_failure
		echo
        else
		if [ -n "$PID" ]; then
			pkill -f "$DAEMON"
			RETVAL=$?
			if [ $RETVAL -eq 0 ]; then
				echo_success
			else
				echo_failure
                		RETVAL=1
			fi
		else
			echo_failure
                	RETVAL=1
		fi
        fi
	echo
        return $RETVAL
}

case "$1" in
start)
  start
;;
stop)
  stop
;;
restart|force-reload)
  stop
  sleep 1
  start
;;
*)
echo "Usage: $SCRIPTNAME {start|stop|restart|force-reload}" >&2
exit 1
;;
esac

exit $RETVAL
